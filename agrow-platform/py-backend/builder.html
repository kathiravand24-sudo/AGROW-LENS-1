<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AgriStack Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <script src="main.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; padding: 0 2rem;">
            <div>
                <h1>üåæ AgriStack Dashboard</h1>
                <p>‡Æµ‡Æø‡Æµ‡Æö‡Ææ‡ÆØ ‡Æ®‡Æø‡Æ≤‡Æ§‡Øç‡Æ§‡Æø‡Æ©‡Øç ‡Æ®‡Æø‡Æ≤‡Øà‡ÆÆ‡Øà‡ÆØ‡Øà ‡Æ™‡Ææ‡Æ∞‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç!</p>
            </div>
            <button id="farmerLogout" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">Logout</button>
        </div>
    </div>
    <div class="dashboard-layout">
        <nav class="sidebar">
            <ul>
                <li class="active" id="nav-overview">Overview</li>
                <li id="nav-weather">Weather</li>
                <li id="nav-tasks">Tasks</li>
                <li id="nav-soil">Soil</li>
                <li id="nav-irrigation">Irrigation</li>
                <li id="nav-yield">Yield</li>
                <li id="nav-defect">Crop Defect Detection</li>
                <li id="nav-marketplace">üõí Marketplace</li>
                <li id="nav-map">Map</li>
            </ul>
        </nav>
        <main>
            <div class="dashboard-section" id="section-overview">
                <div class="section-card">
                    <label for="fieldSelect">Select Field:</label>
                    <select id="fieldSelect">
                        <option>Field 1</option>
                        <option>Field 2</option>
                        <option>Field 3</option>
                    </select>
                    <div class="field-status">
                        <h2>Field Health Summary</h2>
                        <p>üõ∞ NDVI: <strong id="ndviVal">0.72</strong> ‚Äì Healthy üåø</p>
                        <p>üíß Water Stress: <strong id="waterVal">Low</strong></p>
                        <p>üå°Ô∏è Temperature: <strong id="tempVal">28¬∞C</strong></p>
                        <p>üåßÔ∏è Rainfall (last 24h): <strong id="rainVal">12mm</strong></p>
                        <p>üêõ Pest Alert: <strong id="pestVal">None</strong></p>
                        <p id="aiVal">AI Suggestion: ‚Äú‡Æ®‡ØÄ‡Æ∞‡Øç ‡ÆÖ‡Æ≥‡Æµ‡Øà ‡Æö‡ØÄ‡Æ∞‡Ææ‡Æï ‡Æ™‡Æ∞‡Ææ‡ÆÆ‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.‚Äù</p>
                    </div>
                </div>
                <div class="section-card chart-container" style="width: 100%; max-width: 500px;">
                    <canvas id="ndviChart"></canvas>
                </div>
            </div>
            <div class="dashboard-section" id="section-weather" style="display:none;">
                <div class="section-card weather-widget">
                    <h3>3-Day Weather Forecast</h3>
                    <ul id="weatherForecast">
                        <li>Mon: ‚òÄÔ∏è 30¬∞C</li>
                        <li>Tue: üå¶Ô∏è 28¬∞C</li>
                        <li>Wed: üåßÔ∏è 26¬∞C</li>
                    </ul>
                </div>
            </div>
            <div class="dashboard-section" id="section-tasks" style="display:none;">
                <div class="section-card task-list">
                    <h3>Today's Tasks</h3>
                    <input type="text" id="taskInput" placeholder="Add new task..." />
                    <button id="addTaskBtn">Add</button>
                    <ul id="tasks"></ul>
                </div>
            </div>
            <div class="dashboard-section" id="section-soil" style="display:none;">
                <div class="section-card soil-quality">
                    <h3>Soil Quality</h3>
                    <p>pH: <strong id="phVal">6.8</strong></p>
                    <p>Nitrogen: <strong id="nVal">High</strong></p>
                    <p>Phosphorus: <strong id="pVal">Medium</strong></p>
                    <p>Potassium: <strong id="kVal">Low</strong></p>
                </div>
            </div>
            <div class="dashboard-section" id="section-irrigation" style="display:none;">
                <div class="section-card irrigation-scheduler">
                    <h3>Irrigation Scheduler</h3>
                    <p>Next irrigation: <strong>Tomorrow, 6:00 AM</strong></p>
                    <button>View Schedule</button>
                </div>
            </div>
            <div class="dashboard-section" id="section-yield" style="display:none;">
                <div class="section-card yield-prediction">
                    <h3>Yield Prediction</h3>
                    <p>Estimated Yield: <strong>3.2 tons/acre</strong></p>
                </div>
            </div>
            <div class="dashboard-section" id="section-defect" style="display:none;">
                <div class="section-card defect-detection">
                    <h3>üîç Crop Defect Detection</h3>
                    <div class="upload-area">
                        <input type="file" id="cropImage" accept="image/*" style="display:none;">
                        <button id="uploadBtn" class="upload-button">üì∑ Upload Crop Image</button>
                        <div id="imagePreview" style="display:none;">
                            <img id="previewImg" style="max-width:300px;border-radius:8px;margin:10px 0;">
                            <button id="analyzeBtn" class="analyze-button">üî¨ Analyze Defects</button>
                        </div>
                    </div>
                    <div id="analysisResults" style="display:none;">
                        <h4>üéØ Detection Results</h4>
                        <div id="defectsList"></div>
                        <h4>üí° Recommended Solutions</h4>
                        <div id="solutionsList"></div>
                    </div>
                </div>
            </div>
            <div class="dashboard-section" id="section-marketplace" style="display:none;">
                <div class="section-card">
                    <h2>üõí Agricultural Marketplace</h2>
                    <p>Buy quality manure and fertilizers for your crops</p>
                    
                    <div class="marketplace-categories">
                        <button class="category-btn active" data-category="all">All Products</button>
                        <button class="category-btn" data-category="fertilizers">Fertilizers</button>
                        <button class="category-btn" data-category="manure">Organic Manure</button>
                        <button class="category-btn" data-category="seeds">Seeds</button>
                    </div>
                    
                    <div class="products-grid" id="productsGrid">
                        <!-- Products will be populated here -->
                    </div>
                </div>
                
                <div class="section-card" id="cartSection" style="display:none;">
                    <h3>üõí Shopping Cart</h3>
                    <div id="cartItems"></div>
                    <div class="cart-total">
                        <strong>Total: ‚Çπ<span id="cartTotal">0</span></strong>
                        <button id="checkoutBtn" class="checkout-btn">Proceed to Checkout</button>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-section" id="section-map" style="display:none;">
                <div class="section-card field-map">
                    <h3>Field Map</h3>
                    <img src="field-map-demo.png" alt="Field Map" style="width:100%;border-radius:8px;">
                </div>
            </div>
        </main>
    </div>
    <footer>
        <p>&copy; 2025 AgriStack. All rights reserved.</p>
    </footer>
    <script>
        // Check authentication - only farmers can access this dashboard
        if (!localStorage.getItem('userLoggedIn') || localStorage.getItem('userType') !== 'farmer' || !localStorage.getItem('setupComplete')) {
            window.location.href = 'index.html';
        }
        
        // Farmer logout functionality
        document.getElementById('farmerLogout').addEventListener('click', () => {
            localStorage.removeItem('userLoggedIn');
            localStorage.removeItem('userType');
            localStorage.removeItem('userName');
            localStorage.removeItem('farmData');
            localStorage.removeItem('setupComplete');
            window.location.href = 'index.html';
        });

        // Load farmer data from setup
        const farmerData = JSON.parse(localStorage.getItem('farmData') || '{}');
        
        const fieldData = {
    "Field 1": {
        ndvi: 0.72, water: "Low", temp: "28¬∞C", rain: "12mm", pest: "None", ai: "‡Æ®‡ØÄ‡Æ∞‡Øç ‡ÆÖ‡Æ≥‡Æµ‡Øà ‡Æö‡ØÄ‡Æ∞‡Ææ‡Æï ‡Æ™‡Æ∞‡Ææ‡ÆÆ‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.",
        chart: [0.65, 0.68, 0.7, 0.72, 0.71, 0.73, 0.72]
    },
    "Field 2": {
        ndvi: 0.55, water: "Medium", temp: "31¬∞C", rain: "5mm", pest: "Mild", ai: "‡Æ™‡ØÇ‡Æö‡Øç‡Æö‡Æø ‡ÆÆ‡Øá‡Æ≤‡Ææ‡Æ£‡Øç‡ÆÆ‡Øà ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç.",
        chart: [0.5, 0.52, 0.54, 0.55, 0.56, 0.57, 0.55]
    },
    "Field 3": {
        ndvi: 0.40, water: "High", temp: "26¬∞C", rain: "20mm", pest: "High", ai: "‡Æ®‡ØÄ‡Æ∞‡Øç ‡ÆÖ‡Æ≥‡Æµ‡Øà ‡Æï‡ØÅ‡Æ±‡Øà‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.",
        chart: [0.45, 0.43, 0.42, 0.40, 0.41, 0.39, 0.40]
    }
};

let chartInstance;

window.addEventListener('DOMContentLoaded', () => {
    // Update field selector with user's lands
    const select = document.getElementById('fieldSelect');
    select.innerHTML = '';
    
    if (farmerData.lands) {
        farmerData.lands.forEach((land, index) => {
            const option = document.createElement('option');
            option.value = `Land ${index + 1}`;
            option.textContent = `Land ${index + 1} - ${land.crop} (${land.area} acres)`;
            select.appendChild(option);
        });
    }
    
    // Update header with owner name
    if (farmerData.ownerName) {
        document.querySelector('.header h1').textContent = `üåæ ${farmerData.ownerName}'s Farm`;
    }
    const ndvi = document.getElementById('ndviVal');
    const water = document.getElementById('waterVal');
    const temp = document.getElementById('tempVal');
    const rain = document.getElementById('rainVal');
    const pest = document.getElementById('pestVal');
    const ai = document.getElementById('aiVal');
    const ctx = document.getElementById('ndviChart').getContext('2d');

    // Initial chart - use first available field
    const firstFieldKey = Object.keys(fieldData)[0] || "Field 1";
    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'NDVI',
                data: fieldData[firstFieldKey].chart,
                data: [0.65, 0.68, 0.7, 0.72, 0.71, 0.73, 0.72], // Placeholder until fetch
                borderColor: 'green',
                fill: false
            }]
        }
    });

    // Function to fetch real weather data from Open-Meteo API
    // Function to fetch real weather data via Backend Proxy
    async function fetchWeatherData(lat, lon) {
        try {
            // Fetch current weather and daily forecast
            const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=temperature_2m_max,precipitation_sum&timezone=auto`);
            const response = await fetch(`http://localhost:5000/api/weather?lat=${lat}&lon=${lon}`);
            const data = await response.json();
            
            if (data.current_weather) {
                // Update Dashboard Temperature
                document.getElementById('tempVal').textContent = `${data.current_weather.temperature}¬∞C`;
                
                // Update Forecast Widget
                const forecastList = document.getElementById('weatherForecast');
                if (forecastList && data.daily) {
                    forecastList.innerHTML = ''; // Clear mock data
                    
                    // Show next 3 days
                    for(let i=0; i<3; i++) {
                        const date = new Date(data.daily.time[i]).toLocaleDateString('en-US', { weekday: 'short' });
                        const tempMax = data.daily.temperature_2m_max[i];
                        const rainSum = data.daily.precipitation_sum[i];
                        const weatherIcon = rainSum > 0 ? 'üåßÔ∏è' : (tempMax > 30 ? '‚òÄÔ∏è' : '‚õÖ');
                        
                        const li = document.createElement('li');
                        li.innerHTML = `${date}: ${weatherIcon} ${tempMax}¬∞C`;
                        forecastList.appendChild(li);
                    }
                }
            }
        } catch (error) {
            console.error("Error fetching real weather:", error);
        }
    }

    // Function to fetch dynamic field analysis from Backend
    async function updateFieldData(landIndex) {
        try {
            // Call backend to simulate satellite analysis
            const response = await fetch('http://localhost:5000/api/field-analysis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ landIndex: landIndex })
            });
            const data = await response.json();

            // Update UI
            ndvi.textContent = data.ndvi;
            water.textContent = data.water;
            rain.textContent = data.rain;
            pest.textContent = data.pest;
            ai.innerHTML = `AI Suggestion: ‚Äú${data.ai}‚Äù`;
            
            // Update Chart
            chartInstance.data.datasets[0].data = data.chart;
            chartInstance.update();
        } catch (e) {
            console.error("Failed to fetch field analysis", e);
        }
    }

    select.addEventListener('change', () => {
        const selectedField = select.value.replace('Land ', 'Field ');
        const data = fieldData[selectedField] || fieldData['Field 1'];
        ndvi.textContent = data.ndvi;
        water.textContent = data.water;
        // temp.textContent = data.temp; // We will try to fetch real temp first
        rain.textContent = data.rain;
        pest.textContent = data.pest;
        ai.innerHTML = `AI Suggestion: ‚Äú${data.ai}‚Äù`;
        chartInstance.data.datasets[0].data = data.chart;
        chartInstance.update();
        const landIndex = parseInt(select.value.replace('Land ', '')) - 1;
        
        // Update Field Health Data
        updateFieldData(landIndex);

        // Fetch real weather if coordinates exist for this land
        const landIndex = parseInt(select.value.replace('Land ', '')) - 1;
        // Update Weather Data
        if (farmerData.lands && farmerData.lands[landIndex]) {
            const land = farmerData.lands[landIndex];
            if (land.latitude && land.longitude) {
                fetchWeatherData(land.latitude, land.longitude);
            } else {
                temp.textContent = data.temp; // Fallback to mock if no coords
            }
        }
    });

    // Task list logic
    const taskInput = document.getElementById('taskInput');
    const addTaskBtn = document.getElementById('addTaskBtn');
    const tasksUl = document.getElementById('tasks');

    addTaskBtn.addEventListener('click', () => {
        if (taskInput.value.trim() !== "") {
            const li = document.createElement('li');
            li.textContent = taskInput.value;
            li.addEventListener('click', () => li.classList.toggle('done'));
            tasksUl.appendChild(li);
            taskInput.value = "";
        }
    });

    // Initial load weather fetch
    if (farmerData.lands && farmerData.lands.length > 0) {
        const firstLand = farmerData.lands[0];
        if (firstLand.latitude && firstLand.longitude) {
            fetchWeatherData(firstLand.latitude, firstLand.longitude);
            updateFieldData(0);
        }
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const navItems = document.querySelectorAll('.sidebar li');
    const sections = document.querySelectorAll('.dashboard-section');

    navItems.forEach(item => {
        item.addEventListener('click', function() {
            // Remove active class from all
            navItems.forEach(i => i.classList.remove('active'));
            // Add active to clicked
            this.classList.add('active');
            // Hide all sections
            sections.forEach(sec => sec.style.display = 'none');
            // Show the selected section
            const sectionId = 'section-' + this.id.replace('nav-', '');
            const section = document.getElementById(sectionId);
            if (section) section.style.display = '';
        });
    });

    // Crop defect detection functionality
    const uploadBtn = document.getElementById('uploadBtn');
    const cropImage = document.getElementById('cropImage');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const analysisResults = document.getElementById('analysisResults');
    const defectsList = document.getElementById('defectsList');
    const solutionsList = document.getElementById('solutionsList');

    const defectDatabase = {
        'leaf_spot': {
            name: 'Leaf Spot Disease',
            solutions: ['Apply copper-based fungicide', 'Remove affected leaves', 'Improve air circulation']
        },
        'blight': {
            name: 'Blight',
            solutions: ['Use resistant varieties', 'Apply preventive fungicide', 'Ensure proper drainage']
        },
        'pest_damage': {
            name: 'Pest Damage',
            solutions: ['Apply organic pesticide', 'Use beneficial insects', 'Regular monitoring']
        },
        'nutrient_deficiency': {
            name: 'Nutrient Deficiency',
            solutions: ['Apply balanced fertilizer', 'Soil testing recommended', 'Adjust pH levels']
        }
    };

    uploadBtn.addEventListener('click', () => cropImage.click());

    cropImage.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                imagePreview.style.display = 'block';
                analysisResults.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    });

    analyzeBtn.addEventListener('click', async function() {
        analyzeBtn.textContent = 'üîÑ Analyzing...';
        analyzeBtn.disabled = true;
        
        try {
            // Get image data
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = previewImg.width;
            canvas.height = previewImg.height;
            ctx.drawImage(previewImg, 0, 0);
            const imageData = canvas.toDataURL('image/jpeg');
            
            // Send to Python backend
            const response = await fetch('http://localhost:5000/api/analyze-crop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ image: imageData })
            });
            
            if (!response.ok) {
                throw new Error('Analysis failed');
            }
            
            const result = await response.json();
            
            defectsList.innerHTML = '';
            solutionsList.innerHTML = '';
            
            result.detections.forEach(detection => {
                const defectItem = document.createElement('div');
                defectItem.innerHTML = `
                    <div style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; background: #f9f9f9;">
                        <h4 style="color: #d9534f; margin-bottom: 10px;">‚ö†Ô∏è ${detection.name}</h4>
                        <p><strong>Confidence:</strong> ${detection.confidence}%</p>
                        <p><strong>Defect occurring because of:</strong> ${detection.reason}</p>
                        <div style="margin-top: 10px;">
                            <strong>You have this as a solution:</strong>
                            <ul style="margin-top: 5px;">${detection.solutions.map(sol => `<li>${sol}</li>`).join('')}</ul>
                        </div>
                    </div>
                `;
                defectsList.appendChild(defectItem);
            });
            
            analysisResults.style.display = 'block';
            
        } catch (error) {
            console.error('Analysis error:', error);
            // Fallback to mock data if backend is not available
            const detectedDefects = ['leaf_spot', 'nutrient_deficiency'];
            
            defectsList.innerHTML = '';
            solutionsList.innerHTML = '';
            
            detectedDefects.forEach(defectKey => {
                const defect = defectDatabase[defectKey];
                
                const defectItem = document.createElement('div');
                defectItem.innerHTML = `<p><strong>‚ö†Ô∏è ${defect.name}</strong> - Confidence: ${Math.floor(Math.random() * 20 + 80)}%</p>`;
                defectsList.appendChild(defectItem);
                
                const solutionItem = document.createElement('div');
                solutionItem.innerHTML = `<h5>${defect.name} Solutions:</h5><ul>${defect.solutions.map(sol => `<li>${sol}</li>`).join('')}</ul>`;
                solutionsList.appendChild(solutionItem);
            });
            
            analysisResults.style.display = 'block';
        } finally {
            analyzeBtn.textContent = 'üî¨ Analyze Defects';
            analyzeBtn.disabled = false;
        }
    });
    
    // Marketplace functionality
    const marketplaceProducts = [
        { id: 1, name: "NPK Fertilizer (50kg)", category: "fertilizers", price: 1200, image: "üåø", description: "Balanced NPK 10-26-26 for all crops" },
        { id: 2, name: "Urea (50kg)", category: "fertilizers", price: 800, image: "üåø", description: "High nitrogen content for leafy growth" },
        { id: 3, name: "Organic Cow Manure (25kg)", category: "manure", price: 300, image: "üêÑ", description: "Well-decomposed organic manure" },
        { id: 4, name: "Vermicompost (20kg)", category: "manure", price: 400, image: "ü™±", description: "Premium earthworm compost" },
        { id: 5, name: "DAP Fertilizer (50kg)", category: "fertilizers", price: 1400, image: "üåø", description: "Di-ammonium phosphate for root development" },
        { id: 6, name: "Potash (50kg)", category: "fertilizers", price: 900, image: "üåø", description: "Potassium chloride for fruit quality" },
        { id: 7, name: "Hybrid Rice Seeds (10kg)", category: "seeds", price: 2500, image: "üåæ", description: "High-yield hybrid rice variety" },
        { id: 8, name: "Poultry Manure (30kg)", category: "manure", price: 350, image: "üêî", description: "Rich in nitrogen and phosphorus" }
    ];
    let marketplaceProducts = [];
    
    let cart = [];
    
    function renderProducts(products) {
        const grid = document.getElementById('productsGrid');
        grid.innerHTML = products.map(product => `
            <div class="product-card">
                <div class="product-image">${product.image}</div>
                <h4>${product.name}</h4>
                <p class="product-description">${product.description}</p>
                <div class="product-price">‚Çπ${product.price}</div>
                <button class="add-to-cart-btn" onclick="addToCart(${product.id})">Add to Cart</button>
            </div>
        `).join('');
    }
    
    function addToCart(productId) {
        const product = marketplaceProducts.find(p => p.id === productId);
        const existingItem = cart.find(item => item.id === productId);
        
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            cart.push({ ...product, quantity: 1 });
        }
        
        updateCart();
        document.getElementById('cartSection').style.display = 'block';
    }
    
    function updateCart() {
        const cartItems = document.getElementById('cartItems');
        const cartTotal = document.getElementById('cartTotal');
        
        if (cart.length === 0) {
            cartItems.innerHTML = '<p>Your cart is empty</p>';
            cartTotal.textContent = '0';
            return;
        }
        
        cartItems.innerHTML = cart.map(item => `
            <div class="cart-item">
                <span>${item.image} ${item.name}</span>
                <div class="cart-item-controls">
                    <button onclick="changeQuantity(${item.id}, -1)">-</button>
                    <span>${item.quantity}</span>
                    <button onclick="changeQuantity(${item.id}, 1)">+</button>
                    <span class="item-total">‚Çπ${item.price * item.quantity}</span>
                    <button onclick="removeFromCart(${item.id})" class="remove-btn">√ó</button>
                </div>
            </div>
        `).join('');
        
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        cartTotal.textContent = total;
    }
    
    function changeQuantity(productId, change) {
        const item = cart.find(item => item.id === productId);
        if (item) {
            item.quantity += change;
            if (item.quantity <= 0) {
                removeFromCart(productId);
            } else {
                updateCart();
            }
        }
    }
    
    function removeFromCart(productId) {
        cart = cart.filter(item => item.id !== productId);
        updateCart();
        if (cart.length === 0) {
            document.getElementById('cartSection').style.display = 'none';
        }
    }
    
    // Category filtering
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('category-btn')) {
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            
            const category = e.target.dataset.category;
            const filteredProducts = category === 'all' ? marketplaceProducts : 
                marketplaceProducts.filter(p => p.category === category);
            renderProducts(filteredProducts);
        }
    });
    
    // Checkout functionality
    document.getElementById('checkoutBtn').addEventListener('click', function() {
        if (cart.length === 0) {
            alert('Your cart is empty!');
            return;
        }
        
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const orderSummary = cart.map(item => `${item.name} x${item.quantity}`).join('\n');
        
        if (confirm(`Order Summary:\n${orderSummary}\n\nTotal: ‚Çπ${total}\n\nProceed with order?`)) {
            alert('Order placed successfully! You will receive a confirmation call within 24 hours.');
            cart = [];
            updateCart();
            document.getElementById('cartSection').style.display = 'none';
        }
    });
    
    // Initialize marketplace
    renderProducts(marketplaceProducts);
    async function initMarketplace() {
        try {
            const response = await fetch('http://localhost:5000/api/products');
            marketplaceProducts = await response.json();
            renderProducts(marketplaceProducts);
        } catch (e) {
            console.error("Failed to load marketplace", e);
        }
    }
    initMarketplace();
    
    // Make functions global for onclick handlers
    window.addToCart = addToCart;
    window.changeQuantity = changeQuantity;
    window.removeFromCart = removeFromCart;
});
    </script>
</body>
</html>